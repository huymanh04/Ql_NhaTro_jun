@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layoutadmin.cshtml";
}

<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title-wrapper">
            <h1 class="page-title">
                <i class="fas fa-chart-line"></i>
                Dashboard Tổng Quan
            </h1>
            <p class="page-subtitle">Thống kê và báo cáo hệ thống quản lý nhà trọ</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i>
                Làm mới
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Đang tải dữ liệu...</p>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="dashboard-content" style="display: none;">
        
        <!-- Quick Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fas fa-handshake"></i>
                </div>
                <div class="stat-content">
                    <h3 id="soHopDong">0</h3>
                    <p>Hợp Đồng</p>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        <span>Đang hoạt động</span>
                    </div>
                </div>
            </div>

            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fas fa-door-open"></i>
                </div>
                <div class="stat-content">
                    <h3 id="soPhong">0</h3>
                    <p>Tổng Phòng</p>
                    <div class="stat-breakdown">
                        <span class="available">Trống: <strong id="sophongTrong">0</strong></span>
                        <span class="occupied">Đã thuê: <strong id="sophongDaThue">0</strong></span>
                    </div>
                </div>
            </div>

            <div class="stat-card info">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="soKhachHang">0</h3>
                    <p>Khách Hàng</p>
                    <div class="stat-trend">
                        <i class="fas fa-user-plus"></i>
                        <span>Đang thuê</span>
                    </div>
                </div>
            </div>

            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="stat-content">
                    <h3 id="soNhaTro">0</h3>
                    <p>Nhà Trọ</p>
                    <div class="stat-trend">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Địa điểm</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Revenue Charts Section -->
        <div class="charts-section">
            <div class="chart-row">
                <!-- Revenue Overview -->
                <div class="chart-card large">
                    <div class="chart-header">
                        <h3>
                            <i class="fas fa-chart-area"></i>
                            Doanh Thu Theo Thời Gian
                        </h3>
                        <div class="chart-controls">
                            <select id="revenueTimeframe" class="form-control">
                                <option value="day">Theo Ngày</option>
                                <option value="week">Theo Tuần</option>
                                <option value="month" selected>Theo Tháng</option>
                                <option value="year">Theo Năm</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Room Occupancy -->
                <div class="chart-card medium">
                    <div class="chart-header">
                        <h3>
                            <i class="fas fa-chart-pie"></i>
                            Tỷ Lệ Lấp Đầy Phòng
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="occupancyChart"></canvas>
                        <div class="occupancy-stats">
                            <div class="occupancy-item">
                                <span class="color-indicator occupied"></span>
                                <span>Đã thuê: <strong id="occupiedPercent">0%</strong></span>
                            </div>
                            <div class="occupancy-item">
                                <span class="color-indicator available"></span>
                                <span>Còn trống: <strong id="availablePercent">0%</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Utility Bills Chart -->
            <div class="chart-row">
                <div class="chart-card medium">
                    <div class="chart-header">
                        <h3>
                            <i class="fas fa-bolt"></i>
                            Tiền Điện & Nước
                        </h3>
                    </div>
                    <div class="chart-body">
                        <canvas id="utilityChart"></canvas>
                    </div>
                </div>

                <!-- System Stats -->
                <div class="chart-card medium">
                    <div class="chart-header">
                        <h3>
                            <i class="fas fa-cogs"></i>
                            Thống Kê Hệ Thống
                        </h3>
                    </div>
                    <div class="chart-body">
                        <div class="system-stats">
                            <div class="system-stat-item">
                                <div class="system-stat-icon">
                                    <i class="fas fa-map-marked-alt"></i>
                                </div>
                                <div class="system-stat-content">
                                    <h4 id="soTinh">0</h4>
                                    <p>Tỉnh/Thành</p>
                                </div>
                            </div>
                            <div class="system-stat-item">
                                <div class="system-stat-icon">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <div class="system-stat-content">
                                    <h4 id="soLoaiPhong">0</h4>
                                    <p>Loại Phòng</p>
                                </div>
                            </div>
                            <div class="system-stat-item">
                                <div class="system-stat-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div class="system-stat-content">
                                    <h4 id="soBank">0</h4>
                                    <p>Ngân Hàng</p>
                                </div>
                            </div>
                            <div class="system-stat-item">
                                <div class="system-stat-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="system-stat-content">
                                    <h4 id="soTinNhan">0</h4>
                                    <p>Tin Nhắn</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="activity-section">
            <div class="activity-card">
                <div class="activity-header">
                    <h3>
                        <i class="fas fa-clock"></i>
                        Hoạt Động Gần Đây
                    </h3>
                    <a href="#" class="view-all-link">Xem tất cả</a>
                </div>
                <div class="activity-body">
                    <div class="activity-timeline">
                        <div class="timeline-item">
                            <div class="timeline-icon success">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>Hợp đồng mới được ký</h4>
                                <p>Khách hàng Nguyễn Văn A đã ký hợp đồng thuê phòng 101</p>
                                <span class="timeline-time">2 giờ trước</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-icon info">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>Hóa đơn được thanh toán</h4>
                                <p>Hóa đơn tháng 12 của phòng 205 đã được thanh toán</p>
                                <span class="timeline-time">4 giờ trước</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-icon warning">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="timeline-content">
                                <h4>Hóa đơn sắp hết hạn</h4>
                                <p>5 hóa đơn sẽ hết hạn trong 3 ngày tới</p>
                                <span class="timeline-time">6 giờ trước</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let dashboardData = null;
        let revenueChart = null;
        let occupancyChart = null;
        let utilityChart = null;

        // Load dashboard data
        async function loadDashboardData() {
            try {
                showLoading();
                const response = await fetch('/api/Admin/Dashborad');
                const result = await response.json();
                
                if (result.success) {
                    dashboardData = result.data;
                    updateDashboard();
                    hideLoading();
                } else {
                    throw new Error(result.message || 'Lỗi khi tải dữ liệu');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                hideLoading();
                showError('Không thể tải dữ liệu dashboard: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        function showError(message) {
            // You can implement a toast notification here
            alert(message);
        }

        function updateDashboard() {
            if (!dashboardData) return;

            // Update stat cards
            document.getElementById('soHopDong').textContent = dashboardData.soHopDong.toLocaleString();
            document.getElementById('soPhong').textContent = dashboardData.soPhong.toLocaleString();
            document.getElementById('soKhachHang').textContent = dashboardData.soKhachHang.toLocaleString();
            document.getElementById('soNhaTro').textContent = dashboardData.soNhaTro.toLocaleString();
            document.getElementById('sophongTrong').textContent = dashboardData.sophongTrong.toLocaleString();
            document.getElementById('sophongDaThue').textContent = dashboardData.sophongDaThue.toLocaleString();
            document.getElementById('soTinh').textContent = dashboardData.soTinh.toLocaleString();
            document.getElementById('soLoaiPhong').textContent = dashboardData.soLoaiPhong.toLocaleString();
            document.getElementById('soBank').textContent = dashboardData.soBank.toLocaleString();
            document.getElementById('soTinNhan').textContent = dashboardData.soTinNhan.toLocaleString();

            // Update occupancy percentages
            const totalRooms = dashboardData.soPhong;
            const occupiedPercent = totalRooms > 0 ? ((dashboardData.sophongDaThue / totalRooms) * 100).toFixed(1) : 0;
            const availablePercent = totalRooms > 0 ? ((dashboardData.sophongTrong / totalRooms) * 100).toFixed(1) : 0;
            
            document.getElementById('occupiedPercent').textContent = occupiedPercent + '%';
            document.getElementById('availablePercent').textContent = availablePercent + '%';

            // Create charts
            createRevenueChart();
            createOccupancyChart();
            createUtilityChart();
        }

        function createRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }

            const data = {
                labels: ['Hôm qua', 'Hôm nay', 'Tuần trước', 'Tuần này', 'Tháng trước', 'Tháng này'],
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: [
                        dashboardData.homQua,
                        dashboardData.homNay,
                        dashboardData.tuanTruoc,
                        dashboardData.tuanNay,
                        dashboardData.thangTruoc,
                        dashboardData.thangNay
                    ],
                    backgroundColor: 'rgba(74, 144, 164, 0.1)',
                    borderColor: '#4a90a4',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            };

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN', {
                                        style: 'currency',
                                        currency: 'VND'
                                    }).format(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createOccupancyChart() {
            const ctx = document.getElementById('occupancyChart').getContext('2d');
            
            if (occupancyChart) {
                occupancyChart.destroy();
            }

            const data = {
                labels: ['Đã thuê', 'Còn trống'],
                datasets: [{
                    data: [dashboardData.sophongDaThue, dashboardData.sophongTrong],
                    backgroundColor: ['#4a90a4', '#e5e7eb'],
                    borderWidth: 0
                }]
            };

            occupancyChart = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createUtilityChart() {
            const ctx = document.getElementById('utilityChart').getContext('2d');
            
            if (utilityChart) {
                utilityChart.destroy();
            }

            const data = {
                labels: ['Tháng trước', 'Tháng này'],
                datasets: [
                    {
                        label: 'Tiền điện',
                        data: [dashboardData.dienthangtruoc, dashboardData.dienthangnay],
                        backgroundColor: '#f59e0b',
                        borderRadius: 8
                    },
                    {
                        label: 'Tiền nước',
                        data: [dashboardData.nuocthangtruoc, dashboardData.nuocthangnay],
                        backgroundColor: '#06b6d4',
                        borderRadius: 8
                    }
                ]
            };

            utilityChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('vi-VN', {
                                        style: 'currency',
                                        currency: 'VND'
                                    }).format(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });
    </script>
} 